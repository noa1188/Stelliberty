name: æ­£å¼ç‰ˆæ„å»º

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'å‘å¸ƒç‰ˆæœ¬å· (ä¾‹å¦‚: 1.0.0)'
        required: true
        type: string
      create_release:
        description: 'æ˜¯å¦åˆ›å»º GitHub Release'
        required: true
        type: boolean
        default: true

permissions:
  contents: write

jobs:
  # ------------ æå‰å‡†å¤‡ï¼ˆè¯»å–åŒ…å & ç‰ˆæœ¬å·ï¼‰ ------------
  prepare:
    name: å‡†å¤‡æ„å»ºä¿¡æ¯
    runs-on: ubuntu-latest
    outputs:
      pkg: ${{ steps.pkg.outputs.pkg }}
      version: ${{ steps.ver.outputs.version }}
      tag: ${{ steps.tag.outputs.tag }}
      changelog: ${{ steps.changelog.outputs.changelog }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: è¯»å– pubspec.yaml åŒ…å
        id: pkg
        run: |
          pkg=$(grep '^name:' pubspec.yaml | awk '{print $2}')
          echo "ğŸ” æ£€æµ‹åˆ°åŒ…å: $pkg"
          if [ -z "$pkg" ]; then
            echo "::error::æ— æ³•ä» pubspec.yaml æ‰¾åˆ°åŒ…å"
            exit 1
          fi
          echo "pkg=$pkg" >> $GITHUB_OUTPUT

      - name: è¯»å–æˆ–ç”Ÿæˆç‰ˆæœ¬å·
        id: ver
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            version="${{ github.event.inputs.version }}"
            echo "ğŸ“ æ‰‹åŠ¨æŒ‡å®šç‰ˆæœ¬: $version"
          else
            raw=$(grep '^version:' pubspec.yaml | awk '{print $2}')
            version="${raw%%+*}"
            echo "ğŸ“¦ ä» pubspec.yaml è¯»å–ç‰ˆæœ¬: $version"
          fi
          echo "version=$version" >> $GITHUB_OUTPUT

      - name: ç¡®å®š Tag åç§°
        id: tag
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            tag="v${{ github.event.inputs.version }}"
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            tag="${{ github.ref_name }}"
          else
            tag="v${{ steps.ver.outputs.version }}"
          fi
          echo "ğŸ·ï¸ Tag åç§°: $tag"
          echo "tag=$tag" >> $GITHUB_OUTPUT

      - name: éªŒè¯ç‰ˆæœ¬ä¸€è‡´æ€§
        run: |
          tag_version="${{ steps.tag.outputs.tag }}"
          
          # ç§»é™¤ tag ä¸­çš„ 'v' å‰ç¼€
          tag_version_clean="${tag_version#v}"
          
          # å§‹ç»ˆä» pubspec.yaml è¯»å–å®é™…ç‰ˆæœ¬å·ï¼ˆä¸ä½¿ç”¨ç¼“å­˜çš„è¾“å‡ºï¼‰
          actual_pubspec_version=$(grep '^version:' pubspec.yaml | awk '{print $2}' | cut -d'+' -f1)
          
          echo "ğŸ” ç‰ˆæœ¬å¯¹æ¯”ï¼š"
          echo "  Tag ç‰ˆæœ¬:           $tag_version_clean"
          echo "  pubspec.yaml ç‰ˆæœ¬:  $actual_pubspec_version"
          
          if [ "$tag_version_clean" != "$actual_pubspec_version" ]; then
            echo ""
            echo "âŒ é”™è¯¯ï¼šç‰ˆæœ¬å·ä¸ä¸€è‡´ï¼"
            echo ""
            echo "æ¨é€çš„ tag ç‰ˆæœ¬ ($tag_version) ä¸ pubspec.yaml ä¸­çš„å®é™…ç‰ˆæœ¬ ($actual_pubspec_version) ä¸åŒ¹é…ã€‚"
            echo ""
            echo "è¯·æ‰§è¡Œä»¥ä¸‹æ“ä½œä¹‹ä¸€ï¼š"
            echo "  1. æ›´æ–° pubspec.yaml ä¸­çš„ç‰ˆæœ¬å·ä¸º $tag_version_clean"
            echo "  2. åˆ é™¤å½“å‰ tag å¹¶æ¨é€æ­£ç¡®çš„ tag: v$actual_pubspec_version"
            echo ""
            exit 1
          fi
          
          echo "âœ… ç‰ˆæœ¬å·éªŒè¯é€šè¿‡"

      - name: ç”Ÿæˆæ›´æ–°æ—¥å¿—
        id: changelog
        run: |
          echo "ğŸ“ æ­£åœ¨ç”Ÿæˆæ›´æ–°æ—¥å¿—..."
          echo ""
          
          current_tag="${{ steps.tag.outputs.tag }}"
          
          # è·å–æ‰€æœ‰æ­£å¼ç‰ˆ tagï¼ˆæŒ‰ç‰ˆæœ¬å·é™åºï¼‰
          all_release_tags=$(git tag --sort=-version:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' || true)
          
          # æ’é™¤å½“å‰ tagï¼Œè·å–ä¸Šä¸€ä¸ªæ­£å¼ç‰ˆ
          previous_tag=$(echo "$all_release_tags" | grep -v "^${current_tag}$" | head -n 1 || true)
          
          if [ -z "$previous_tag" ]; then
            echo "âš ï¸  æœªæ‰¾åˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬ tagï¼Œä½¿ç”¨é¦–ä¸ªæäº¤"
            previous_tag=$(git rev-list --max-parents=0 HEAD)
          fi
          
          echo "ğŸ“ ç‰ˆæœ¬èŒƒå›´: $previous_tag â†’ $current_tag"
          echo ""
          
          # å®šä¹‰è¦å¿½ç•¥çš„æ–‡ä»¶è·¯å¾„æ¨¡å¼
          IGNORE_FILE_PATTERNS="^\.github/|^scripts/|\.yml$|\.yaml$|^README|^LICENSE|^\.gitignore|^\.metadata|^analysis_options\.yaml|^pubspec\.lock$"
          
          # ç”Ÿæˆæäº¤æ—¥å¿—
          {
            echo "## ğŸ“‹ æ›´æ–°æ—¥å¿—"
            echo ""
            echo "è‡ª $previous_tag ä»¥æ¥çš„åŠŸèƒ½å’Œä¿®å¤ï¼š"
            echo ""
            echo "> ğŸ’¡ å·²è‡ªåŠ¨è¿‡æ»¤ CI/Workflow/æ–‡æ¡£ ç›¸å…³çš„ç»´æŠ¤æ€§æäº¤"
            echo ""

            # è·å–æ‰€æœ‰æäº¤å¹¶å¤„ç†
            total_count=0
            filtered_count=0
            included_count=0
            
            # è·å–æ‰€æœ‰æäº¤å“ˆå¸Œ
            commit_hashes=$(git rev-list $previous_tag..HEAD --no-merges)
            
            # éå†æ¯ä¸ªæäº¤
            for hash in $commit_hashes; do
              total_count=$((total_count + 1))
              
              # è·å–æäº¤æ¶‰åŠçš„æ–‡ä»¶åˆ—è¡¨
              changed_files=$(git diff-tree --no-commit-id --name-only -r "$hash")
              
              # æ£€æŸ¥æ˜¯å¦æ‰€æœ‰æ–‡ä»¶éƒ½åŒ¹é…å¿½ç•¥æ¨¡å¼
              should_ignore=true
              for file in $changed_files; do
                if ! echo "$file" | grep -qE "$IGNORE_FILE_PATTERNS"; then
                  should_ignore=false
                  break
                fi
              done
              
              # å¦‚æœæ‰€æœ‰æ–‡ä»¶éƒ½æ˜¯è¦å¿½ç•¥çš„ç±»å‹ï¼Œè·³è¿‡è¿™ä¸ªæäº¤
              if [ "$should_ignore" = true ]; then
                filtered_count=$((filtered_count + 1))
                continue
              fi
              
              included_count=$((included_count + 1))
              
              # è·å–æäº¤ä¿¡æ¯ï¼ˆåˆ†åˆ«è·å–é¿å…åˆ†éš”ç¬¦é—®é¢˜ï¼‰
              subject=$(git log -1 --pretty=format:"%s" "$hash")
              author=$(git log -1 --pretty=format:"%an" "$hash")
              time=$(git log -1 --pretty=format:"%ar" "$hash")
              
              # è¾“å‡ºæ ¼å¼åŒ–çš„æäº¤ä¿¡æ¯
              echo "### $subject"
              echo ""
              echo "**æäº¤**: \`${hash:0:7}\` | **ä½œè€…**: $author | **æ—¶é—´**: $time"
              echo ""
              
              # æ˜¾ç¤ºæ¶‰åŠçš„ä¸»è¦æ–‡ä»¶ï¼ˆæ’é™¤å¿½ç•¥çš„æ–‡ä»¶ï¼‰
              main_files=""
              for file in $changed_files; do
                if ! echo "$file" | grep -qE "$IGNORE_FILE_PATTERNS"; then
                  if [ -z "$main_files" ]; then
                    main_files="$file"
                  else
                    main_files="$main_files, $file"
                  fi
                fi
              done
              
              if [ -n "$main_files" ]; then
                echo "**æ¶‰åŠæ–‡ä»¶**: $main_files"
                echo ""
              fi
              
              # è·å–æäº¤æ­£æ–‡ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
              body=$(git log -1 --pretty=format:"%b" "$hash" | sed '/^$/d')
              if [ -n "$body" ]; then
                echo "$body"
                echo ""
              fi
              
              echo "---"
              echo ""
            done
            
            echo "---"
            echo ""
            echo "**ç»Ÿè®¡ä¿¡æ¯**"
            echo "- ğŸ“Š æ€»æäº¤æ•°: $total_count"
            echo "- âœ… åŠŸèƒ½/ä¿®å¤æäº¤: $included_count"
            echo "- ğŸ”§ CI/ç»´æŠ¤æäº¤: $filtered_count (å·²è¿‡æ»¤)"

          } > changelog.md
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“‹ ç”Ÿæˆçš„æ›´æ–°æ—¥å¿—é¢„è§ˆï¼š"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          cat changelog.md
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          # è¾“å‡ºåˆ° GitHub Actionsï¼ˆä½¿ç”¨ base64 ç¼–ç é¿å…ç‰¹æ®Šå­—ç¬¦é—®é¢˜ï¼‰
          changelog_base64=$(base64 -w 0 changelog.md)
          echo "changelog=$changelog_base64" >> $GITHUB_OUTPUT

  # ------------ æ„å»º jobï¼ˆä¾èµ– prepareï¼‰ ------------
  build:
    name: æ„å»º Windows-${{ matrix.arch }}
    needs: prepare
    outputs:
      mihomo_version: ${{ steps.prebuild.outputs.mihomo_version }}
    strategy:
      matrix:
        include:
          - arch: x64
            runs-on: windows-latest
          - arch: arm64
            runs-on: windows-11-arm
    runs-on: ${{ matrix.runs-on }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v6

      - name: è¾“å‡ºæ„å»ºä¿¡æ¯
        shell: pwsh
        run: |
          Write-Host "============================================"
          Write-Host "ğŸ“¦ åŒ…å:        ${{ needs.prepare.outputs.pkg }}"
          Write-Host "â« ç‰ˆæœ¬å·:      ${{ needs.prepare.outputs.version }}"
          Write-Host "ğŸ·ï¸ Tag:         ${{ needs.prepare.outputs.tag }}"
          Write-Host "ğŸ–¥ï¸ æ¶æ„:        ${{ matrix.arch }}"
          Write-Host "============================================"

      - name: é…ç½® Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: master

      - name: é…ç½® Rust
        uses: dtolnay/rust-toolchain@stable

      - name: å®‰è£…é¡¹ç›®ä¾èµ–
        shell: pwsh
        run: |
          Write-Host "ğŸ“¦ æ­£åœ¨å®‰è£…é¡¹ç›®ä¾èµ–..."
          
          Write-Host "  â¤ å®‰è£… Flutter ä¸»é¡¹ç›®ä¾èµ–"
          flutter pub get
          
          Write-Host "  â¤ å®‰è£… rinf_cli"
          cargo install rinf_cli
          
          Write-Host "âœ… æ‰€æœ‰ä¾èµ–å®‰è£…å®Œæˆ"

      - name: å®‰è£…é¢„æ„å»ºè„šæœ¬ä¾èµ–
        run: dart pub get
        working-directory: scripts

      - name: è¿è¡Œé¢„æ„å»ºè„šæœ¬
        id: prebuild
        shell: pwsh
        run: |
          Write-Host "ğŸ”§ æ­£åœ¨è¿è¡Œé¢„æ„å»ºè„šæœ¬ï¼ˆåŒ…å« Inno Setup å®‰è£…ï¼‰..."
          
          # æ•è·é¢„æ„å»ºè„šæœ¬çš„è¾“å‡º
          $output = dart run scripts/prebuild.dart --installer 2>&1 | Tee-Object -Variable prebuildOutput
          
          # ä»è¾“å‡ºä¸­æå– Mihomo ç‰ˆæœ¬å·
          $versionLine = $prebuildOutput | Select-String -Pattern "æ‰¾åˆ°æ ¸å¿ƒ:.*ç‰ˆæœ¬å·:\s*v([\d\.]+)" | Select-Object -First 1
          
          if ($versionLine -and $versionLine.Matches.Groups.Count -gt 1) {
            $mihomoVersion = $versionLine.Matches.Groups[1].Value
            Write-Host "âœ… æ£€æµ‹åˆ° Mihomo æ ¸å¿ƒç‰ˆæœ¬: $mihomoVersion"
            echo "mihomo_version=$mihomoVersion" >> $env:GITHUB_OUTPUT
          } else {
            Write-Host "âš ï¸ æœªèƒ½ä»è¾“å‡ºä¸­æå– Mihomo ç‰ˆæœ¬å·"
            echo "mihomo_version=unknown" >> $env:GITHUB_OUTPUT
          }

      - name: ç”Ÿæˆ Rust æ¡¥æ¥ä»£ç 
        run: rinf gen

      - name: ç”Ÿæˆå¤šè¯­è¨€æ–‡ä»¶
        run: dart run slang

      - name: è¿è¡Œæ„å»ºè„šæœ¬
        shell: pwsh
        run: |
          Write-Host "ğŸ—ï¸ æ­£åœ¨è¿è¡Œæ„å»ºè„šæœ¬..."
          dart run scripts/build.dart --all-installers

      - name: å¤åˆ¶æ„å»ºäº§ç‰©åˆ° dist
        shell: pwsh
        run: |
          Write-Host "ğŸ“¦ æ­£åœ¨å¤åˆ¶æ„å»ºäº§ç‰©..."
          
          # ç¡®ä¿ dist ç›®å½•å­˜åœ¨
          New-Item -ItemType Directory -Force -Path dist | Out-Null
          
          # æ£€æŸ¥ build/packages ç›®å½•
          if (Test-Path "build/packages") {
            # å¤åˆ¶æ‰€æœ‰æ–‡ä»¶åˆ° dist
            Copy-Item -Path "build/packages/*" -Destination "dist/" -Recurse -Force
            
            Write-Host "âœ… æ„å»ºäº§ç‰©å·²å¤åˆ¶åˆ° dist/"
            Write-Host ""
            Write-Host "ğŸ“¦ äº§ç‰©åˆ—è¡¨:"
            Get-ChildItem -Path "dist/" | ForEach-Object {
              $size = if ($_.PSIsContainer) { "ç›®å½•" } else { "$([math]::Round($_.Length / 1MB, 2)) MB" }
              Write-Host "  - $($_.Name) ($size)"
            }
          } else {
            Write-Host "âŒ é”™è¯¯: build/packages ç›®å½•ä¸å­˜åœ¨"
            exit 1
          }

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ${{ needs.prepare.outputs.pkg }}-windows-${{ matrix.arch }}
          path: dist/*
          retention-days: 90

  # ------------ åˆ›å»ºæ­£å¼å‘å¸ƒ ------------
  release:
    name: åˆ›å»ºæ­£å¼å‘å¸ƒ
    needs: [prepare, build]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || (github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true')
    outputs:
      mihomo_version: ${{ steps.get_mihomo_version.outputs.version }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v6

      - name: è§£ç æ›´æ–°æ—¥å¿—
        id: decode_changelog
        run: |
          echo "ğŸ“ æ­£åœ¨è§£ç æ›´æ–°æ—¥å¿—..."
          
          # ä» prepare job è·å– base64 ç¼–ç çš„æ›´æ–°æ—¥å¿—
          changelog_base64="${{ needs.prepare.outputs.changelog }}"
          
          if [ -n "$changelog_base64" ]; then
            # è§£ç  base64
            echo "$changelog_base64" | base64 -d > changelog.md
            
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“‹ è§£ç çš„æ›´æ–°æ—¥å¿—é¢„è§ˆï¼š"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            cat changelog.md
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            
            # è¾“å‡ºåˆ° GitHub Actions
            {
              echo 'changelog<<EOF'
              cat changelog.md
              echo EOF
            } >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ æœªæ‰¾åˆ°æ›´æ–°æ—¥å¿—ï¼Œä½¿ç”¨é»˜è®¤å†…å®¹"
            echo "changelog=## ğŸ“‹ æ›´æ–°æ—¥å¿—\n\næš‚æ— æ›´æ–°æ—¥å¿—ä¿¡æ¯ã€‚" >> $GITHUB_OUTPUT
          fi

      - name: è·å– Mihomo ç‰ˆæœ¬å·
        id: get_mihomo_version
        run: |
          # ä» build job çš„è¾“å‡ºä¸­è·å– mihomo_version
          mihomo_ver="${{ needs.build.outputs.mihomo_version }}"
          if [ -z "$mihomo_ver" ] || [ "$mihomo_ver" = "unknown" ]; then
            echo "âš ï¸ æœªèƒ½è·å– Mihomo ç‰ˆæœ¬å·ï¼Œä½¿ç”¨é»˜è®¤å€¼"
            mihomo_ver="æœªçŸ¥"
          else
            echo "âœ… Mihomo æ ¸å¿ƒç‰ˆæœ¬: $mihomo_ver"
          fi
          echo "version=$mihomo_ver" >> $GITHUB_OUTPUT
      
      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare.outputs.tag }}
          name: ${{ needs.prepare.outputs.pkg }} ${{ needs.prepare.outputs.version }} ç¨³å®šç‰ˆæ›´æ–°ï¼
          body: |
            ### ğŸ“¦ æ„å»ºä¿¡æ¯
            
            | é¡¹ç›® | å†…å®¹ |
            |------|------|
            | **åŒ…å** | `${{ needs.prepare.outputs.pkg }}` |
            | **ç‰ˆæœ¬å·** | `${{ needs.prepare.outputs.version }}` |
            | **Mihomo æ ¸å¿ƒ** | `${{ steps.get_mihomo_version.outputs.version }}` |
            | **æäº¤å“ˆå¸Œ** | [`${{ github.sha }}`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}) |
            
            ${{ steps.decode_changelog.outputs.changelog }}
            
            ---
            
            ### ğŸ“¥ ä¸‹è½½è¯´æ˜
            
            - **x64**: é€‚ç”¨äº Intel/AMD 64ä½å¤„ç†å™¨ï¼ˆæ¨èï¼‰
            - **arm64**: é€‚ç”¨äº ARM64 å¤„ç†å™¨
            
            ### ğŸ“ å®‰è£…è¯´æ˜
            
            1. ä¸‹è½½å¯¹åº”æ¶æ„çš„æ–‡ä»¶
            2. æŒ‰ç…§æ–‡ä»¶ç±»å‹è¿›è¡Œå®‰è£…æˆ–è§£å‹
            3. è¿è¡Œåº”ç”¨ç¨‹åº
            
            ### âš ï¸ é‡è¦æç¤º
            
            - å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·æŸ¥çœ‹é¡¹ç›®æ–‡æ¡£æˆ–æäº¤ Issue
            - åé¦ˆé—®é¢˜æ—¶è¯·é™„ä¸Šç›¸å…³æ—¥å¿—æ–‡ä»¶

          files: artifacts/**/*
          draft: false
          prerelease: false
          overwrite_files: true
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}